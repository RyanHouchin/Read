<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Read</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Instrument+Serif&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #080808; color: #c8c8c8; font-family: 'DM Sans', sans-serif;
    min-height: 100vh; display: flex; justify-content: center;
    padding: 48px 20px; -webkit-font-smoothing: antialiased;
  }
  .wrap { width: 100%; max-width: 540px; display: flex; flex-direction: column; align-items: center; gap: 28px; }

  .upload-screen { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 24px; }
  .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; text-align: center; }
  .logo-dot { width: 5px; height: 5px; border-radius: 50%; background: #fff; }
  .logo h1 { font-family: 'Instrument Serif', serif; font-size: 40px; font-weight: 400; color: #f0f0f0; letter-spacing: -0.02em; }
  .logo p { font-size: 13px; color: #4a4a4a; font-weight: 300; }

  .drop-zone {
    width: 100%; min-height: 220px; border: 1px solid #181818; border-radius: 14px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    background: #0c0c0c; padding: 36px; overflow: hidden; position: relative;
  }
  .drop-zone.has-img { padding: 0; min-height: auto; cursor: default; }
  .drop-zone input { display: none; }
  .drop-hint { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .drop-hint p { font-size: 13px; color: #555; }
  .drop-hint small { font-size: 11px; color: #2a2a2a; }

  .preview-wrap { position: relative; width: 100%; }
  .preview-wrap img { width: 100%; max-height: 500px; object-fit: contain; border-radius: 13px; display: block; background: #0a0a0a; }
  .remove-btn {
    position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; border-radius: 50%;
    border: none; background: rgba(0,0,0,.65); color: #777; font-size: 12px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  .analyze-btn {
    width: 100%; padding: 14px 0; background: #fff; color: #000; border: none; border-radius: 10px;
    font-size: 13px; font-weight: 500; font-family: 'DM Sans', sans-serif; cursor: pointer;
  }
  .analyze-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* Scan */
  .scan-screen { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
  .scan-container { width: 100%; position: relative; border-radius: 14px; overflow: hidden; background: #0a0a0a; }
  .scan-container img { width: 100%; max-height: 500px; object-fit: contain; display: block; background: #0a0a0a; }
  .scan-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  .scan-text { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; }
  .scan-text h2 { font-family: 'Instrument Serif', serif; font-size: 22px; color: #ddd; font-weight: 400; }
  .scan-phase { font-size: 10px; color: #333; letter-spacing: 0.1em; text-transform: uppercase; min-height: 14px; font-family: 'DM Mono', monospace; }
  .progress-wrap { width: 100%; max-width: 280px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .progress-track { width: 100%; height: 2px; background: #161616; border-radius: 1px; overflow: hidden; }
  .progress-fill { width: 0%; height: 100%; background: #555; border-radius: 1px; transition: width 0.3s ease-out; }
  .progress-label { font-size: 10px; color: #282828; font-variant-numeric: tabular-nums; font-family: 'DM Mono', monospace; }

  /* Error */
  .error-box { width: 100%; padding: 16px 18px; background: #140c0c; border: 1px solid #2a1515; border-radius: 10px; }
  .error-box p { font-size: 12px; color: #cc6666; line-height: 1.6; }
  .error-box button { margin-top: 12px; padding: 8px 16px; background: transparent; color: #666; border: 1px solid #2a1515; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; }

  /* Report */
  .report { width: 100%; display: flex; flex-direction: column; gap: 40px; }
  .hr { height: 1px; background: #111; }
  .body-text { font-size: 14px; line-height: 1.9; color: #8a8a8a; font-weight: 300; }

  /* Hero */
  .hero { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 16px; }
  .hero-avatar { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid #1a1a1a; }
  .hero-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .hero-archetype { font-size: 10px; color: #353535; letter-spacing: 0.28em; text-transform: uppercase; }
  .hero-opening { font-family: 'Instrument Serif', serif; font-size: 22px; color: #cdcdcd; line-height: 1.55; max-width: 480px; font-weight: 400; }
  .hero-fi-label { font-size: 9px; color: #222; letter-spacing: 0.14em; text-transform: uppercase; }
  .hero-fi { font-size: 13px; color: #505050; font-style: italic; font-weight: 300; }

  /* Section headers */
  .sec-head { display: flex; align-items: baseline; gap: 10px; margin-bottom: 20px; }
  .sec-num { font-size: 10px; color: #252525; font-variant-numeric: tabular-nums; letter-spacing: 0.06em; font-weight: 500; }
  .sec-label { font-size: 10px; color: #404040; text-transform: uppercase; letter-spacing: 0.16em; }
  .sec-line { flex: 1; height: 1px; background: #151515; }

  /* Rating */
  .rating-wrap { display: flex; align-items: center; gap: 32px; flex-wrap: wrap; justify-content: center; }
  .ring-container { position: relative; }
  .ring-value { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .ring-num { font-family: 'Instrument Serif', serif; font-size: 56px; color: #f0f0f0; line-height: 1; letter-spacing: -0.04em; }
  .ring-label { font-size: 10px; color: #333; font-weight: 300; margin-top: 6px; letter-spacing: 0.12em; text-transform: uppercase; }
  .rating-detail { flex: 1; min-width: 180px; display: flex; flex-direction: column; gap: 8px; }
  .rating-row { display: flex; justify-content: space-between; align-items: baseline; }
  .rating-key { font-size: 11px; color: #303030; text-transform: uppercase; letter-spacing: 0.08em; }
  .rating-val { font-family: 'Instrument Serif', serif; font-size: 24px; }
  .rating-context { font-size: 12px; line-height: 1.7; font-weight: 300; color: #505050; }
  .scale-note { font-size: 10px; color: #282828; line-height: 1.6; margin-top: 8px; padding-top: 8px; border-top: 1px solid #111; }

  /* Metrics */
  .metrics-grid { display: flex; flex-direction: column; gap: 0; }
  .metric-item { padding: 16px 0; border-bottom: 1px solid #0f0f0f; }
  .metric-item:last-child { border-bottom: none; }
  .metric-top { display: flex; align-items: baseline; gap: 12px; margin-bottom: 8px; }
  .metric-name { font-size: 10px; color: #404040; text-transform: uppercase; letter-spacing: 0.1em; min-width: 100px; }
  .metric-value { font-family: 'DM Mono', monospace; font-size: 15px; color: #b0b0b0; min-width: 56px; }
  .metric-note { font-size: 11px; color: #3a3a3a; line-height: 1.6; font-weight: 300; flex: 1; }
  .metric-avg { font-size: 9px; color: #252525; font-family: 'DM Mono', monospace; margin-left: 4px; }
  /* Scale bar */
  .metric-scale { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-left: 112px; }
  .scale-track { flex: 1; height: 3px; background: #111; border-radius: 2px; position: relative; max-width: 220px; }
  .scale-dot {
    position: absolute; top: 50%; width: 8px; height: 8px; border-radius: 50%;
    background: #888; transform: translate(-50%, -50%); transition: left 0.6s ease-out;
  }
  .scale-avg-mark {
    position: absolute; top: -3px; bottom: -3px; width: 1px; background: #222;
  }
  .scale-labels { display: flex; justify-content: space-between; width: 100%; max-width: 220px; margin-left: 112px; margin-top: 2px; }
  .scale-lbl { font-size: 8px; color: #1e1e1e; text-transform: uppercase; letter-spacing: 0.08em; }

  /* Body comp */
  .body-comp {
    border: 1px solid #161616; border-radius: 12px; padding: 20px; background: #0a0a0a;
  }
  .body-comp-header { display: flex; align-items: baseline; gap: 16px; margin-bottom: 10px; }
  .bf-stat { display: flex; flex-direction: column; align-items: center; }
  .bf-label { font-size: 9px; color: #303030; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }
  .bf-value { font-family: 'DM Mono', monospace; font-size: 20px; color: #b0b0b0; }
  .bf-arrow { font-size: 16px; color: #252525; padding-top: 10px; }
  .bf-target .bf-value { color: #6a9a6a; }
  .body-comp p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; margin-top: 10px; }

  /* Angle */
  .angle-card { border: 1px solid #161616; border-radius: 12px; padding: 18px 20px; background: #0a0a0a; display: flex; align-items: flex-start; gap: 16px; }
  .angle-icon { width: 36px; height: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .angle-body { flex: 1; }
  .angle-body h4 { font-size: 13px; color: #aaa; font-weight: 500; margin-bottom: 4px; }
  .angle-body p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; }

  /* Cards */
  .card { border: 1px solid #161616; border-radius: 12px; padding: 18px 20px; background: #0a0a0a; }
  .card.leak { border-color: #1a1212; background: #0a0909; }
  .card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .card h4 { font-size: 13px; color: #aaa; font-weight: 500; }
  .card p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; padding-left: 14px; }
  .diamond { width: 6px; height: 6px; border-radius: 1px; background: #252525; transform: rotate(45deg); }

  /* Moves */
  .move { display: flex; gap: 16px; }
  .move-num { font-size: 10px; color: #222; font-variant-numeric: tabular-nums; padding-top: 3px; font-weight: 500; min-width: 16px; }
  .move-body { flex: 1; }
  .move-body h4 { font-size: 13px; color: #aaa; font-weight: 500; margin-bottom: 5px; }
  .move-body p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; }
  .impact-bar { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .impact-track { width: 48px; height: 3px; background: #131313; border-radius: 2px; overflow: hidden; }
  .impact-fill { height: 100%; border-radius: 2px; }
  .impact-label { font-size: 9px; color: #282828; text-transform: uppercase; letter-spacing: 0.1em; }

  .footer { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 0 32px; }
  .footer-dot { width: 4px; height: 4px; border-radius: 50%; background: #1e1e1e; }
  .footer span { font-size: 11px; color: #1e1e1e; letter-spacing: 0.1em; font-weight: 300; }

  .new-read-btn {
    width: 100%; padding: 13px 0; background: transparent; color: #4a4a4a;
    border: 1px solid #1a1a1a; border-radius: 10px; font-size: 12px;
    font-family: 'DM Sans', sans-serif; cursor: pointer; margin-bottom: 32px;
  }

  .hidden { display: none !important; }

  @media (max-width: 480px) {
    .metric-scale { padding-left: 0; }
    .scale-labels { margin-left: 0; }
    .metric-top { flex-wrap: wrap; }
    .metric-note { min-width: 100%; margin-top: 4px; }
  }
</style>
</head>
<body>
<div class="wrap">

  <div id="upload-screen" class="upload-screen">
    <div class="logo">
      <div class="logo-dot"></div>
      <h1>Read</h1>
      <p>Upload a photo. Get the structural read.</p>
    </div>
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
      <input type="file" id="file-input" accept="image/*">
      <div class="drop-hint" id="drop-hint">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#3a3a3a" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
        <p>Tap to upload a photo</p>
        <small>Clear, well-lit, front-facing works best</small>
      </div>
      <div class="preview-wrap hidden" id="preview-wrap">
        <img id="preview-img" src="" alt="">
        <button class="remove-btn" id="remove-btn" onclick="event.stopPropagation(); resetAll();">&#10005;</button>
      </div>
    </div>
    <button class="analyze-btn hidden" id="analyze-btn" onclick="analyze()">Analyze</button>
  </div>

  <div id="scan-screen" class="scan-screen hidden">
    <div class="scan-container" id="scan-container">
      <img id="scan-img" src="" alt="">
      <canvas class="scan-canvas" id="scan-canvas"></canvas>
    </div>
    <div class="scan-text">
      <h2>Reading the architecture</h2>
      <span class="scan-phase" id="scan-phase"></span>
      <div class="progress-wrap">
        <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
        <span class="progress-label" id="progress-label">0%</span>
      </div>
    </div>
  </div>

  <div id="error-box" class="error-box hidden">
    <p id="error-msg"></p>
    <button onclick="resetAll()">Try Again</button>
  </div>

  <div id="report" class="report hidden"></div>
</div>

<script>
let compressedBase64 = null;
let previewURL = null;
let scanAnimationId = null;
let progressInterval = null;

document.getElementById('file-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  compressImage(file);
});

function compressImage(file) {
  compressedBase64 = null;
  hideError();
  previewURL = URL.createObjectURL(file);
  document.getElementById('preview-img').src = previewURL;
  document.getElementById('drop-hint').classList.add('hidden');
  document.getElementById('preview-wrap').classList.remove('hidden');
  document.getElementById('drop-zone').classList.add('has-img');
  document.getElementById('drop-zone').onclick = null;
  const reader = new FileReader();
  reader.onload = function() {
    const img = new Image();
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        let w = img.naturalWidth, h = img.naturalHeight;
        const MAX = 768;
        if (w > MAX || h > MAX) {
          if (w >= h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        compressedBase64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
        document.getElementById('analyze-btn').classList.remove('hidden');
        document.getElementById('analyze-btn').disabled = false;
      } catch (err) { showError('Could not process: ' + err.message); }
    };
    img.onerror = () => showError('Could not decode image.');
    img.src = reader.result;
  };
  reader.onerror = () => showError('Could not read file.');
  reader.readAsDataURL(file);
}

// ============ HUD SCAN ANIMATION ============

function startScanAnimation() {
  const canvas = document.getElementById('scan-canvas');
  const container = document.getElementById('scan-container');
  const ctx = canvas.getContext('2d');

  function initCanvas() {
    const rect = container.getBoundingClientRect();
    const W = canvas.width = rect.width;
    const H = canvas.height = rect.height;
    const cx = W / 2, cy = H / 2;
    const startTime = Date.now();

    const phases = [
      'DETECTING FACIAL STRUCTURE',
      'MAPPING SYMMETRY AXIS',
      'CALCULATING FWHR',
      'MEASURING CANTHAL TILT',
      'ANALYZING PROPORTIONS',
      'EVALUATING JAWLINE',
      'COMPUTING FACIAL THIRDS',
      'GENERATING REPORT'
    ];

    function draw() {
      const elapsed = Date.now() - startTime;
      ctx.clearRect(0, 0, W, H);

      // Dark overlay
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fillRect(0, 0, W, H);

      // Grid lines
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.025)';
      ctx.lineWidth = 0.5;
      const gridSpacing = 40;
      for (let x = gridSpacing; x < W; x += gridSpacing) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
      }
      for (let y = gridSpacing; y < H; y += gridSpacing) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
      }

      // Scan line (horizontal sweep)
      const scanY = ((elapsed * 0.08) % (H + 60)) - 30;
      const scanGrad = ctx.createLinearGradient(0, scanY - 20, 0, scanY + 20);
      scanGrad.addColorStop(0, 'rgba(255, 255, 255, 0)');
      scanGrad.addColorStop(0.5, 'rgba(255, 255, 255, 0.08)');
      scanGrad.addColorStop(1, 'rgba(255, 255, 255, 0)');
      ctx.fillStyle = scanGrad;
      ctx.fillRect(0, scanY - 20, W, 40);

      // Thin bright scan line
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(0, scanY); ctx.lineTo(W, scanY); ctx.stroke();

      // Center crosshair
      const chSize = Math.min(W, H) * 0.08;
      const chGap = 6;
      const chAlpha = 0.12 + Math.sin(elapsed * 0.003) * 0.04;
      ctx.strokeStyle = `rgba(255, 255, 255, ${chAlpha})`;
      ctx.lineWidth = 1;
      // Top
      ctx.beginPath(); ctx.moveTo(cx, cy - chSize); ctx.lineTo(cx, cy - chGap); ctx.stroke();
      // Bottom
      ctx.beginPath(); ctx.moveTo(cx, cy + chGap); ctx.lineTo(cx, cy + chSize); ctx.stroke();
      // Left
      ctx.beginPath(); ctx.moveTo(cx - chSize, cy); ctx.lineTo(cx - chGap, cy); ctx.stroke();
      // Right
      ctx.beginPath(); ctx.moveTo(cx + chGap, cy); ctx.lineTo(cx + chSize, cy); ctx.stroke();

      // Rotating measurement arc
      const arcR = Math.min(W, H) * 0.22;
      const arcAngle = elapsed * 0.0015;
      const arcLen = Math.PI * 0.4;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.06)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(cx, cy, arcR, arcAngle, arcAngle + arcLen);
      ctx.stroke();
      // Second arc opposite
      ctx.beginPath();
      ctx.arc(cx, cy, arcR, arcAngle + Math.PI, arcAngle + Math.PI + arcLen);
      ctx.stroke();

      // Inner rotating arc (smaller, opposite direction)
      const arcR2 = Math.min(W, H) * 0.15;
      const arcAngle2 = -elapsed * 0.001;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)';
      ctx.beginPath();
      ctx.arc(cx, cy, arcR2, arcAngle2, arcAngle2 + arcLen * 0.6);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(cx, cy, arcR2, arcAngle2 + Math.PI, arcAngle2 + Math.PI + arcLen * 0.6);
      ctx.stroke();

      // Corner brackets
      const bLen = 22, bPad = 14;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(bPad, bPad+bLen); ctx.lineTo(bPad, bPad); ctx.lineTo(bPad+bLen, bPad); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(W-bPad-bLen, bPad); ctx.lineTo(W-bPad, bPad); ctx.lineTo(W-bPad, bPad+bLen); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(bPad, H-bPad-bLen); ctx.lineTo(bPad, H-bPad); ctx.lineTo(bPad+bLen, H-bPad); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(W-bPad-bLen, H-bPad); ctx.lineTo(W-bPad, H-bPad); ctx.lineTo(W-bPad, H-bPad-bLen); ctx.stroke();

      // Data readout text
      const phaseIdx = Math.floor((elapsed / 2200) % phases.length);
      const phaseText = phases[phaseIdx];
      ctx.font = '9px "DM Mono", monospace';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.18)';
      ctx.fillText(phaseText, bPad + 4, H - bPad - 8);

      // Top-right timestamp-style readout
      const fakeData = [
        'SYM: ' + (5 + Math.sin(elapsed * 0.001) * 2).toFixed(1),
        'FWHR: ' + (1.7 + Math.sin(elapsed * 0.0008) * 0.3).toFixed(2),
        'CT: ' + (Math.sin(elapsed * 0.0012) * 5).toFixed(1) + '°'
      ];
      const dataIdx = Math.floor((elapsed / 1600) % fakeData.length);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.12)';
      ctx.textAlign = 'right';
      ctx.fillText(fakeData[dataIdx], W - bPad - 4, bPad + 14);
      ctx.textAlign = 'left';

      // Update phase text below image
      const phaseEl = document.getElementById('scan-phase');
      if (phaseEl) phaseEl.textContent = phaseText;

      scanAnimationId = requestAnimationFrame(draw);
    }
    draw();
  }

  const img = document.getElementById('scan-img');
  if (img.complete && img.naturalHeight > 0) setTimeout(initCanvas, 80);
  else img.onload = () => setTimeout(initCanvas, 80);
}

function stopScanAnimation() {
  if (scanAnimationId) { cancelAnimationFrame(scanAnimationId); scanAnimationId = null; }
  if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
}

function startProgress() {
  let progress = 0;
  const fill = document.getElementById('progress-fill');
  const label = document.getElementById('progress-label');
  progressInterval = setInterval(() => {
    if (progress < 60) progress += 1.8 + Math.random() * 1.2;
    else if (progress < 85) progress += 0.4 + Math.random() * 0.6;
    else if (progress < 92) progress += 0.1 + Math.random() * 0.2;
    progress = Math.min(progress, 92);
    fill.style.width = progress + '%';
    label.textContent = Math.round(progress) + '%';
  }, 400);
}

function finishProgress() {
  if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
  document.getElementById('progress-fill').style.width = '100%';
  document.getElementById('progress-label').textContent = '100%';
}

// ============ ANALYZE ============

async function analyze() {
  if (!compressedBase64) return;
  document.getElementById('upload-screen').classList.add('hidden');
  document.getElementById('scan-screen').classList.remove('hidden');
  hideError();
  document.getElementById('scan-img').src = previewURL;
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('progress-label').textContent = '0%';
  document.getElementById('scan-phase').textContent = '';
  startScanAnimation();
  startProgress();

  try {
    const resp = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: compressedBase64, media_type: 'image/jpeg' })
    });
    const data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || 'Status ' + resp.status);
    if (!data.opening || data.rating === undefined) throw new Error('Incomplete response.');
    finishProgress();
    document.getElementById('scan-phase').textContent = 'ANALYSIS COMPLETE';
    await new Promise(r => setTimeout(r, 700));
    stopScanAnimation();
    document.getElementById('scan-screen').classList.add('hidden');
    renderReport(data);
  } catch (err) {
    stopScanAnimation();
    document.getElementById('scan-screen').classList.add('hidden');
    document.getElementById('upload-screen').classList.remove('hidden');
    showError(err.message);
  }
}

// ============ METRIC SCALE HELPERS ============

function scalePosition(value, min, max, avgPos) {
  // Returns 0-100 percentage position
  const clamped = Math.max(min, Math.min(max, value));
  return ((clamped - min) / (max - min)) * 100;
}

function metricScaleHTML(name, value, displayVal, note, avgLabel, min, max, avgVal) {
  const pos = scalePosition(value, min, max);
  const avgPos = scalePosition(avgVal, min, max);
  return `
    <div class="metric-item">
      <div class="metric-top">
        <span class="metric-name">${name}</span>
        <span class="metric-value">${displayVal}</span>
        <span class="metric-avg">avg: ${avgLabel}</span>
      </div>
      <div class="metric-note" style="padding-left:112px;margin-bottom:6px">${esc(note)}</div>
      <div class="metric-scale">
        <div class="scale-track">
          <div class="scale-avg-mark" style="left:${avgPos}%"></div>
          <div class="scale-dot" style="left:${pos}%"></div>
        </div>
      </div>
      <div class="scale-labels">
        <span class="scale-lbl">Low</span>
        <span class="scale-lbl">Avg</span>
        <span class="scale-lbl">High</span>
      </div>
    </div>`;
}

// ============ RENDER REPORT ============

function renderReport(d) {
  const report = document.getElementById('report');
  const rating = parseFloat(d.rating) || 0;
  const ceiling = parseFloat(d.ceiling) || 0;
  const ringSize = 180, sw = 5;
  const r = (ringSize - sw * 2) / 2;
  const c = 2 * Math.PI * r;

  const m = d.metrics || {};
  const sym = m.symmetry || {};
  const fwhr = m.fwhr || {};
  const ct = m.canthal_tilt || {};
  const ft = m.facial_thirds || {};
  const jl = m.jawline || {};

  const fwhrVal = fwhr.value ? parseFloat(fwhr.value) : 1.9;
  const ctDeg = ct.degrees !== undefined ? parseFloat(ct.degrees) : 0;
  const ctDisplay = ct.direction && ct.degrees !== undefined
    ? (ct.direction === 'positive' ? '+' : ct.direction === 'negative' ? '-' : '') + ct.degrees + '°'
    : '—';

  // Build metrics with visual scales
  let metricsHTML = '';
  metricsHTML += metricScaleHTML('Symmetry', parseFloat(sym.score) || 5, (parseFloat(sym.score) || 5).toFixed(1), sym.note || '', '5.0', 1, 10, 5);
  metricsHTML += metricScaleHTML('FWHR', fwhrVal, fwhrVal.toFixed(2), fwhr.note || '', '1.90', 1.5, 2.4, 1.9);
  metricsHTML += metricScaleHTML('Canthal Tilt', ctDeg, ctDisplay, ct.note || '', '0°', -6, 8, 0);
  // Thirds is categorical, use a simpler row
  const ftBalance = ft.balance ? ft.balance.charAt(0).toUpperCase() + ft.balance.slice(1) : '—';
  metricsHTML += `
    <div class="metric-item">
      <div class="metric-top">
        <span class="metric-name">Thirds</span>
        <span class="metric-value">${esc(ftBalance)}</span>
        <span class="metric-avg">avg: Balanced</span>
      </div>
      <div class="metric-note" style="padding-left:112px">${esc(ft.note || '')}</div>
    </div>`;
  metricsHTML += metricScaleHTML('Jawline', parseFloat(jl.score) || 5, (parseFloat(jl.score) || 5).toFixed(1), jl.note || '', '5.0', 1, 10, 5);

  // Body composition
  const bc = d.body_composition || {};
  const bcHTML = bc.current_bf_estimate ? `
    <div class="body-comp">
      <div class="body-comp-header">
        <div class="bf-stat">
          <span class="bf-label">Current</span>
          <span class="bf-value">${esc(bc.current_bf_estimate)}</span>
        </div>
        <span class="bf-arrow">→</span>
        <div class="bf-stat bf-target">
          <span class="bf-label">Target</span>
          <span class="bf-value">${esc(bc.target_bf)}</span>
        </div>
      </div>
      <p>${esc(bc.note || '')}</p>
    </div>` : '';

  // Features
  let featuresHTML = '';
  (d.best_features || []).forEach(f => {
    featuresHTML += `<div class="card" style="margin-bottom:12px"><div class="card-head"><div class="diamond"></div><h4>${esc(f.feature)}</h4></div><p>${esc(f.detail)}</p></div>`;
  });

  // Leaks
  let leaksHTML = '';
  (d.leaks || []).forEach(l => {
    leaksHTML += `<div class="card leak" style="margin-bottom:12px"><div class="card-head"><svg width="8" height="8" viewBox="0 0 8 8"><polygon points="4,7 0.5,1 7.5,1" fill="none" stroke="#3a2525" stroke-width="1"/></svg><h4>${esc(l.issue)}</h4></div><p style="padding-left:16px">${esc(l.detail)}</p></div>`;
  });

  // Moves
  let movesHTML = '';
  (d.moves || []).forEach((mv, i) => {
    const pct = mv.impact === 'high' ? '100%' : mv.impact === 'medium' ? '66%' : '33%';
    const col = mv.impact === 'high' ? '#888' : '#333';
    movesHTML += `<div class="move" style="margin-bottom:22px"><span class="move-num">${String(i+1).padStart(2,'0')}</span><div class="move-body"><h4>${esc(mv.action)}</h4><p>${esc(mv.detail)}</p><div class="impact-bar"><div class="impact-track"><div class="impact-fill" style="width:${pct};background:${col}"></div></div><span class="impact-label">${esc(mv.impact)} impact</span></div></div></div>`;
  });

  // Best angle
  const ba = d.best_angle || {};
  const angleSide = (ba.side || 'straight-on').toLowerCase();
  let angleArrow = '';
  if (angleSide.includes('left')) angleArrow = '<path d="M20 12H4M4 12l6-6M4 12l6 6" stroke="#444" stroke-width="1.5" fill="none"/>';
  else if (angleSide.includes('right')) angleArrow = '<path d="M4 12h16M20 12l-6-6M20 12l-6 6" stroke="#444" stroke-width="1.5" fill="none"/>';
  else angleArrow = '<circle cx="12" cy="12" r="3" stroke="#444" stroke-width="1.5" fill="none"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke="#333" stroke-width="1" fill="none"/>';

  report.innerHTML = `
    <div class="hero">
      ${previewURL ? `<div class="hero-avatar"><img src="${previewURL}" alt=""></div>` : ''}
      <div class="hero-archetype">${esc(d.archetype || '')}</div>
      <p class="hero-opening">${esc(d.opening)}</p>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:6px">
        <span class="hero-fi-label">First impression</span>
        <span class="hero-fi">${esc(d.first_impression || '')}</span>
      </div>
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">01</span>
        <span class="sec-label">Overall Rating</span>
        <div class="sec-line"></div>
      </div>
      <div class="rating-wrap">
        <div class="ring-container" style="width:${ringSize}px;height:${ringSize}px">
          <svg width="${ringSize}" height="${ringSize}" style="transform:rotate(-90deg)">
            <circle cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#141414" stroke-width="${sw}"/>
            <circle cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#222" stroke-width="${sw}"
              stroke-dasharray="${c}" stroke-dashoffset="${c-(ceiling/10)*c}" stroke-linecap="round" opacity="0.5"/>
            <circle id="rating-arc" cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#bbb" stroke-width="${sw}"
              stroke-dasharray="${c}" stroke-dashoffset="${c}" stroke-linecap="round"/>
          </svg>
          <div class="ring-value">
            <span class="ring-num" id="ring-num">0.0</span>
            <span class="ring-label">of 10</span>
          </div>
        </div>
        <div class="rating-detail">
          <div class="rating-row">
            <span class="rating-key">Current</span>
            <span class="rating-val" style="color:#bbb">${rating.toFixed(1)}</span>
          </div>
          <div class="rating-row">
            <span class="rating-key">Ceiling</span>
            <span class="rating-val" style="color:#404040">${ceiling.toFixed(1)}</span>
          </div>
          <div style="height:1px;background:#151515;margin:6px 0"></div>
          <p class="rating-context">${esc(d.rating_context || '')}</p>
          <p class="rating-context">${esc(d.ceiling_context || '')}</p>
          <p class="scale-note">5 is average — most people fall between 4 and 6. A 7+ is notably above average. 8+ is rare.</p>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">02</span>
        <span class="sec-label">Structural Metrics</span>
        <div class="sec-line"></div>
      </div>
      <div class="metrics-grid">${metricsHTML}</div>
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">03</span>
        <span class="sec-label">Personality &amp; Intent</span>
        <div class="sec-line"></div>
      </div>
      <p class="body-text">${esc(d.personality || '')}</p>
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">04</span>
        <span class="sec-label">The Shadow</span>
        <div class="sec-line"></div>
      </div>
      <p class="body-text">${esc(d.shadow || '')}</p>
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">05</span>
        <span class="sec-label">Strongest Architecture</span>
        <div class="sec-line"></div>
      </div>
      ${featuresHTML}
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">06</span>
        <span class="sec-label">Structural Leaks</span>
        <div class="sec-line"></div>
      </div>
      ${leaksHTML}
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">07</span>
        <span class="sec-label">Highest-ROI Moves</span>
        <div class="sec-line"></div>
      </div>
      ${movesHTML}
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">08</span>
        <span class="sec-label">Body Composition</span>
        <div class="sec-line"></div>
      </div>
      ${bcHTML}
    </div>

    <div class="hr"></div>

    <div>
      <div class="sec-head">
        <span class="sec-num">09</span>
        <span class="sec-label">Best Angle</span>
        <div class="sec-line"></div>
      </div>
      <div class="angle-card">
        <div class="angle-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none">${angleArrow}</svg></div>
        <div class="angle-body">
          <h4>${esc(angleSide.charAt(0).toUpperCase() + angleSide.slice(1))}</h4>
          <p>${esc(ba.note || '')}</p>
        </div>
      </div>
    </div>

    <div class="hr" style="margin-top:16px"></div>
    <div class="footer"><div class="footer-dot"></div><span>Read</span></div>
  `;

  report.classList.remove('hidden');
  const btn = document.createElement('button');
  btn.className = 'new-read-btn';
  btn.textContent = 'New Read';
  btn.onclick = resetAll;
  report.after(btn);
  animateRing(rating, c);
}

function animateRing(target, circumference) {
  const arc = document.getElementById('rating-arc');
  const num = document.getElementById('ring-num');
  if (!arc || !num) return;
  const t0 = Date.now();
  function tick() {
    const p = Math.min((Date.now() - t0) / 1400, 1);
    const eased = 1 - Math.pow(1 - p, 3);
    const v = eased * target;
    arc.setAttribute('stroke-dashoffset', circumference - (v / 10) * circumference);
    num.textContent = v.toFixed(1);
    if (p < 1) requestAnimationFrame(tick);
  }
  setTimeout(() => requestAnimationFrame(tick), 300);
}

function showError(msg) { document.getElementById('error-msg').textContent = msg; document.getElementById('error-box').classList.remove('hidden'); }
function hideError() { document.getElementById('error-box').classList.add('hidden'); }

function resetAll() {
  compressedBase64 = null;
  if (previewURL) { URL.revokeObjectURL(previewURL); previewURL = null; }
  stopScanAnimation();
  document.getElementById('drop-hint').classList.remove('hidden');
  document.getElementById('preview-wrap').classList.add('hidden');
  document.getElementById('drop-zone').classList.remove('has-img');
  document.getElementById('drop-zone').onclick = function() { document.getElementById('file-input').click(); };
  document.getElementById('analyze-btn').classList.add('hidden');
  document.getElementById('file-input').value = '';
  document.getElementById('scan-screen').classList.add('hidden');
  document.getElementById('report').classList.add('hidden');
  document.getElementById('report').innerHTML = '';
  hideError();
  document.getElementById('upload-screen').classList.remove('hidden');
  const nb = document.querySelector('.new-read-btn');
  if (nb) nb.remove();
}

function esc(s) { if (!s) return ''; const el = document.createElement('div'); el.textContent = s; return el.innerHTML; }
</script>
</body>
</html>
