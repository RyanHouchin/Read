<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Read</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Instrument+Serif&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #080808;
    color: #c8c8c8;
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 48px 20px;
    -webkit-font-smoothing: antialiased;
  }
  .wrap { width: 100%; max-width: 540px; display: flex; flex-direction: column; align-items: center; gap: 28px; }

  /* Upload screen */
  .upload-screen { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 24px; }
  .logo { display: flex; flex-direction: column; align-items: center; gap: 10px; text-align: center; }
  .logo-dot { width: 5px; height: 5px; border-radius: 50%; background: #fff; }
  .logo h1 { font-family: 'Instrument Serif', serif; font-size: 40px; font-weight: 400; color: #f0f0f0; letter-spacing: -0.02em; }
  .logo p { font-size: 13px; color: #4a4a4a; font-weight: 300; }

  .drop-zone {
    width: 100%; min-height: 220px; border: 1px solid #181818; border-radius: 14px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    background: #0c0c0c; padding: 36px; overflow: hidden; position: relative;
  }
  .drop-zone.has-img { padding: 0; min-height: auto; cursor: default; }
  .drop-zone input { display: none; }
  .drop-hint { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .drop-hint p { font-size: 13px; color: #555; }
  .drop-hint small { font-size: 11px; color: #2a2a2a; }

  .preview-wrap { position: relative; width: 100%; }
  .preview-wrap img {
    width: 100%; max-height: 500px; object-fit: contain; border-radius: 13px; display: block;
    background: #0a0a0a;
  }
  .remove-btn {
    position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; border-radius: 50%;
    border: none; background: rgba(0,0,0,.65); color: #777; font-size: 12px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  .analyze-btn {
    width: 100%; padding: 14px 0; background: #fff; color: #000; border: none; border-radius: 10px;
    font-size: 13px; font-weight: 500; font-family: 'DM Sans', sans-serif; cursor: pointer; letter-spacing: 0.02em;
  }
  .analyze-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* Loading / Scan Screen */
  .scan-screen {
    width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px;
  }
  .scan-container {
    width: 100%; position: relative; border-radius: 14px; overflow: hidden;
    background: #0a0a0a;
  }
  .scan-container img {
    width: 100%; max-height: 500px; object-fit: contain; display: block;
    background: #0a0a0a;
  }
  .scan-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
  }
  .scan-text {
    display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;
  }
  .scan-text h2 {
    font-family: 'Instrument Serif', serif; font-size: 22px; color: #ddd; font-weight: 400;
  }
  .progress-wrap {
    width: 100%; max-width: 280px; display: flex; flex-direction: column; align-items: center; gap: 8px;
  }
  .progress-track {
    width: 100%; height: 2px; background: #161616; border-radius: 1px; overflow: hidden;
  }
  .progress-fill {
    width: 0%; height: 100%; background: #555; border-radius: 1px;
    transition: width 0.3s ease-out;
  }
  .progress-label {
    font-size: 10px; color: #282828; font-variant-numeric: tabular-nums; letter-spacing: 0.06em;
  }

  /* Error */
  .error-box {
    width: 100%; padding: 16px 18px; background: #140c0c; border: 1px solid #2a1515; border-radius: 10px;
  }
  .error-box p { font-size: 12px; color: #cc6666; line-height: 1.6; }
  .error-box button {
    margin-top: 12px; padding: 8px 16px; background: transparent; color: #666;
    border: 1px solid #2a1515; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif;
  }

  /* Report */
  .report { width: 100%; display: flex; flex-direction: column; gap: 40px; }
  .hr { height: 1px; background: #111; }
  .body-text { font-size: 14px; line-height: 1.9; color: #8a8a8a; font-weight: 300; letter-spacing: 0.005em; }

  /* Hero */
  .hero { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 16px; }
  .hero-avatar {
    width: 80px; height: 80px; border-radius: 50%; overflow: hidden;
    border: 2px solid #1a1a1a; box-shadow: 0 0 60px rgba(255,255,255,0.02);
  }
  .hero-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .hero-archetype { font-size: 10px; color: #353535; letter-spacing: 0.28em; text-transform: uppercase; font-weight: 400; }
  .hero-opening { font-family: 'Instrument Serif', serif; font-size: 22px; color: #cdcdcd; line-height: 1.55; max-width: 480px; font-weight: 400; }
  .hero-fi-label { font-size: 9px; color: #222; letter-spacing: 0.14em; text-transform: uppercase; }
  .hero-fi { font-size: 13px; color: #505050; font-style: italic; font-weight: 300; }

  /* Section headers */
  .sec-head { display: flex; align-items: baseline; gap: 10px; margin-bottom: 20px; }
  .sec-num { font-size: 10px; color: #252525; font-variant-numeric: tabular-nums; letter-spacing: 0.06em; font-weight: 500; }
  .sec-label { font-size: 10px; color: #404040; text-transform: uppercase; letter-spacing: 0.16em; font-weight: 400; }
  .sec-line { flex: 1; height: 1px; background: #151515; }

  /* Rating */
  .rating-wrap { display: flex; align-items: center; gap: 32px; flex-wrap: wrap; justify-content: center; }
  .ring-container { position: relative; }
  .ring-value {
    position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .ring-num { font-family: 'Instrument Serif', serif; font-size: 56px; color: #f0f0f0; line-height: 1; letter-spacing: -0.04em; }
  .ring-label { font-size: 10px; color: #333; font-weight: 300; margin-top: 6px; letter-spacing: 0.12em; text-transform: uppercase; }
  .rating-detail { flex: 1; min-width: 180px; display: flex; flex-direction: column; gap: 8px; }
  .rating-row { display: flex; justify-content: space-between; align-items: baseline; }
  .rating-key { font-size: 11px; color: #303030; text-transform: uppercase; letter-spacing: 0.08em; }
  .rating-val { font-family: 'Instrument Serif', serif; font-size: 24px; }
  .rating-context { font-size: 12px; line-height: 1.7; font-weight: 300; }
  .scale-note {
    font-size: 10px; color: #282828; line-height: 1.6; margin-top: 8px; padding-top: 8px;
    border-top: 1px solid #111; letter-spacing: 0.01em;
  }

  /* Cards */
  .card {
    border: 1px solid #161616; border-radius: 12px; padding: 18px 20px; background: #0a0a0a;
  }
  .card.leak { border-color: #1a1212; background: #0a0909; }
  .card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .card h4 { font-size: 13px; color: #aaa; font-weight: 500; }
  .card p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; padding-left: 14px; }
  .diamond { width: 6px; height: 6px; border-radius: 1px; background: #252525; transform: rotate(45deg); }

  /* Moves */
  .move { display: flex; gap: 16px; }
  .move-num { font-size: 10px; color: #222; font-variant-numeric: tabular-nums; padding-top: 3px; font-weight: 500; min-width: 16px; }
  .move-body { flex: 1; }
  .move-body h4 { font-size: 13px; color: #aaa; font-weight: 500; margin-bottom: 5px; }
  .move-body p { font-size: 12px; color: #505050; line-height: 1.7; font-weight: 300; }
  .impact-bar { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .impact-track { width: 48px; height: 3px; background: #131313; border-radius: 2px; overflow: hidden; }
  .impact-fill { height: 100%; border-radius: 2px; }
  .impact-label { font-size: 9px; color: #282828; text-transform: uppercase; letter-spacing: 0.1em; }

  /* Footer */
  .footer { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 0 32px; }
  .footer-dot { width: 4px; height: 4px; border-radius: 50%; background: #1e1e1e; }
  .footer span { font-size: 11px; color: #1e1e1e; letter-spacing: 0.1em; font-weight: 300; }

  .new-read-btn {
    width: 100%; padding: 13px 0; background: transparent; color: #4a4a4a;
    border: 1px solid #1a1a1a; border-radius: 10px; font-size: 12px;
    font-family: 'DM Sans', sans-serif; cursor: pointer; margin-bottom: 32px;
  }

  .hidden { display: none !important; }
</style>
</head>
<body>
<div class="wrap">

  <!-- UPLOAD SCREEN -->
  <div id="upload-screen" class="upload-screen">
    <div class="logo">
      <div class="logo-dot"></div>
      <h1>Read</h1>
      <p>Upload a photo. Get the structural read.</p>
    </div>

    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
      <input type="file" id="file-input" accept="image/*">
      <div class="drop-hint" id="drop-hint">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#3a3a3a" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
        <p>Tap to upload a photo</p>
        <small>Clear, well-lit, front-facing works best</small>
      </div>
      <div class="preview-wrap hidden" id="preview-wrap">
        <img id="preview-img" src="" alt="">
        <button class="remove-btn" id="remove-btn" onclick="event.stopPropagation(); resetAll();">&#10005;</button>
      </div>
    </div>

    <button class="analyze-btn hidden" id="analyze-btn" onclick="analyze()">Analyze</button>
  </div>

  <!-- SCAN / LOADING SCREEN -->
  <div id="scan-screen" class="scan-screen hidden">
    <div class="scan-container" id="scan-container">
      <img id="scan-img" src="" alt="">
      <canvas class="scan-canvas" id="scan-canvas"></canvas>
    </div>
    <div class="scan-text">
      <h2>Reading the architecture</h2>
      <div class="progress-wrap">
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <span class="progress-label" id="progress-label">0%</span>
      </div>
    </div>
  </div>

  <!-- ERROR -->
  <div id="error-box" class="error-box hidden">
    <p id="error-msg"></p>
    <button onclick="resetAll()">Try Again</button>
  </div>

  <!-- REPORT -->
  <div id="report" class="report hidden"></div>

</div>

<script>
let compressedBase64 = null;
let previewURL = null;
let scanAnimationId = null;
let progressInterval = null;

// File selection
document.getElementById('file-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  compressImage(file);
});

function compressImage(file) {
  compressedBase64 = null;
  hideError();

  previewURL = URL.createObjectURL(file);
  const previewImg = document.getElementById('preview-img');
  previewImg.src = previewURL;
  document.getElementById('drop-hint').classList.add('hidden');
  document.getElementById('preview-wrap').classList.remove('hidden');
  document.getElementById('drop-zone').classList.add('has-img');
  document.getElementById('drop-zone').onclick = null;

  const reader = new FileReader();
  reader.onload = function() {
    const img = new Image();
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        let w = img.naturalWidth;
        let h = img.naturalHeight;
        const MAX = 768;
        if (w > MAX || h > MAX) {
          if (w >= h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const dataURL = canvas.toDataURL('image/jpeg', 0.6);
        compressedBase64 = dataURL.split(',')[1];
        document.getElementById('analyze-btn').classList.remove('hidden');
        document.getElementById('analyze-btn').disabled = false;
      } catch (err) {
        showError('Could not process this image: ' + err.message);
      }
    };
    img.onerror = function() {
      showError('Could not decode this image. Try a JPEG or PNG file.');
    };
    img.src = reader.result;
  };
  reader.onerror = function() {
    showError('Could not read this file.');
  };
  reader.readAsDataURL(file);
}

// ============ FACE SCAN ANIMATION ============

function startScanAnimation() {
  const canvas = document.getElementById('scan-canvas');
  const container = document.getElementById('scan-container');
  const img = document.getElementById('scan-img');
  const ctx = canvas.getContext('2d');

  // Wait for image to load to get dimensions
  function initCanvas() {
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    // Generate points concentrated in center (face area)
    const points = [];
    const numPoints = 100;
    const cx = canvas.width / 2;
    const cy = canvas.height * 0.4; // faces are usually upper-center
    const spreadX = canvas.width * 0.4;
    const spreadY = canvas.height * 0.4;

    for (let i = 0; i < numPoints; i++) {
      // Gaussian-ish distribution centered on face area
      const angle = Math.random() * Math.PI * 2;
      const dist = Math.random() * 0.8 + 0.2;
      const rx = (Math.random() - 0.5) * 2;
      const ry = (Math.random() - 0.5) * 2;
      // Mix of concentrated center + wider spread
      const isCentered = Math.random() < 0.65;
      const x = isCentered
        ? cx + rx * spreadX * dist * 0.6
        : cx + rx * spreadX * 1.2;
      const y = isCentered
        ? cy + ry * spreadY * dist * 0.6
        : cy + ry * spreadY * 1.4;

      points.push({
        x: Math.max(8, Math.min(canvas.width - 8, x)),
        y: Math.max(8, Math.min(canvas.height - 8, y)),
        size: 1.2 + Math.random() * 1.8,
        delay: i * 30 + Math.random() * 400, // staggered appearance
        opacity: 0,
        pulse: Math.random() * Math.PI * 2,
        pulseSpeed: 0.02 + Math.random() * 0.03
      });
    }

    // Sort by delay for progressive reveal
    points.sort((a, b) => a.delay - b.delay);

    const connectionDist = Math.min(canvas.width, canvas.height) * 0.15;
    let scanLineY = -20;
    const startTime = Date.now();

    function draw() {
      const elapsed = Date.now() - startTime;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Subtle dark overlay for contrast
      ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Scan line sweep
      scanLineY = ((elapsed * 0.06) % (canvas.height + 80)) - 40;
      const grad = ctx.createLinearGradient(0, scanLineY - 30, 0, scanLineY + 30);
      grad.addColorStop(0, 'rgba(255, 255, 255, 0)');
      grad.addColorStop(0.5, 'rgba(255, 255, 255, 0.04)');
      grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, scanLineY - 30, canvas.width, 60);

      // Update point opacities
      points.forEach(p => {
        if (elapsed > p.delay) {
          p.opacity = Math.min(1, p.opacity + 0.04);
        }
        p.pulse += p.pulseSpeed;
      });

      // Draw connections first (behind points)
      const visiblePoints = points.filter(p => p.opacity > 0.1);
      ctx.lineWidth = 0.5;
      for (let i = 0; i < visiblePoints.length; i++) {
        for (let j = i + 1; j < visiblePoints.length; j++) {
          const a = visiblePoints[i];
          const b = visiblePoints[j];
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < connectionDist) {
            const alpha = (1 - dist / connectionDist) * 0.15 * Math.min(a.opacity, b.opacity);
            ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }
        }
      }

      // Draw points
      visiblePoints.forEach(p => {
        const pulseSize = p.size + Math.sin(p.pulse) * 0.5;
        const alpha = p.opacity * (0.6 + Math.sin(p.pulse) * 0.2);

        // Glow
        ctx.beginPath();
        ctx.arc(p.x, p.y, pulseSize * 3, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.06})`;
        ctx.fill();

        // Point
        ctx.beginPath();
        ctx.arc(p.x, p.y, pulseSize, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.7})`;
        ctx.fill();
      });

      // Corner brackets (subtle framing)
      const bLen = 24;
      const bPad = 16;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      // Top-left
      ctx.beginPath();
      ctx.moveTo(bPad, bPad + bLen); ctx.lineTo(bPad, bPad); ctx.lineTo(bPad + bLen, bPad);
      ctx.stroke();
      // Top-right
      ctx.beginPath();
      ctx.moveTo(canvas.width - bPad - bLen, bPad); ctx.lineTo(canvas.width - bPad, bPad); ctx.lineTo(canvas.width - bPad, bPad + bLen);
      ctx.stroke();
      // Bottom-left
      ctx.beginPath();
      ctx.moveTo(bPad, canvas.height - bPad - bLen); ctx.lineTo(bPad, canvas.height - bPad); ctx.lineTo(bPad + bLen, canvas.height - bPad);
      ctx.stroke();
      // Bottom-right
      ctx.beginPath();
      ctx.moveTo(canvas.width - bPad - bLen, canvas.height - bPad); ctx.lineTo(canvas.width - bPad, canvas.height - bPad); ctx.lineTo(canvas.width - bPad, canvas.height - bPad - bLen);
      ctx.stroke();

      scanAnimationId = requestAnimationFrame(draw);
    }

    draw();
  }

  // Small delay to let image render
  if (img.complete && img.naturalHeight > 0) {
    setTimeout(initCanvas, 50);
  } else {
    img.onload = () => setTimeout(initCanvas, 50);
  }
}

function stopScanAnimation() {
  if (scanAnimationId) {
    cancelAnimationFrame(scanAnimationId);
    scanAnimationId = null;
  }
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

function startProgress() {
  let progress = 0;
  const fill = document.getElementById('progress-fill');
  const label = document.getElementById('progress-label');

  progressInterval = setInterval(() => {
    // Ease toward 88% over ~25 seconds, then slow crawl
    if (progress < 60) {
      progress += 1.8 + Math.random() * 1.2;
    } else if (progress < 85) {
      progress += 0.4 + Math.random() * 0.6;
    } else if (progress < 92) {
      progress += 0.1 + Math.random() * 0.2;
    }
    progress = Math.min(progress, 92);
    fill.style.width = progress + '%';
    label.textContent = Math.round(progress) + '%';
  }, 400);
}

function finishProgress() {
  if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
  const fill = document.getElementById('progress-fill');
  const label = document.getElementById('progress-label');
  fill.style.width = '100%';
  label.textContent = '100%';
}

// ============ ANALYZE ============

async function analyze() {
  if (!compressedBase64) return;

  // Switch to scan screen
  document.getElementById('upload-screen').classList.add('hidden');
  document.getElementById('scan-screen').classList.remove('hidden');
  hideError();

  // Set the scan image
  document.getElementById('scan-img').src = previewURL;

  // Reset progress
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('progress-label').textContent = '0%';

  // Start animations
  startScanAnimation();
  startProgress();

  try {
    const resp = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image: compressedBase64,
        media_type: 'image/jpeg'
      })
    });

    const data = await resp.json();

    if (!resp.ok || data.error) {
      throw new Error(data.error || 'Server returned status ' + resp.status);
    }

    if (!data.opening || data.rating === undefined) {
      throw new Error('Incomplete response. Try again.');
    }

    // Complete progress, brief pause, then show report
    finishProgress();
    await new Promise(r => setTimeout(r, 600));
    stopScanAnimation();

    document.getElementById('scan-screen').classList.add('hidden');
    renderReport(data);

  } catch (err) {
    stopScanAnimation();
    document.getElementById('scan-screen').classList.add('hidden');
    document.getElementById('upload-screen').classList.remove('hidden');
    showError(err.message);
  }
}

// ============ RENDER REPORT ============

function renderReport(d) {
  const report = document.getElementById('report');

  let featuresHTML = '';
  (d.best_features || []).forEach(f => {
    featuresHTML += `
      <div class="card" style="margin-bottom:12px">
        <div class="card-head"><div class="diamond"></div><h4>${esc(f.feature)}</h4></div>
        <p>${esc(f.detail)}</p>
      </div>`;
  });

  let leaksHTML = '';
  (d.leaks || []).forEach(l => {
    leaksHTML += `
      <div class="card leak" style="margin-bottom:12px">
        <div class="card-head">
          <svg width="8" height="8" viewBox="0 0 8 8"><polygon points="4,7 0.5,1 7.5,1" fill="none" stroke="#3a2525" stroke-width="1"/></svg>
          <h4>${esc(l.issue)}</h4>
        </div>
        <p style="padding-left:16px">${esc(l.detail)}</p>
      </div>`;
  });

  let movesHTML = '';
  (d.moves || []).forEach((m, i) => {
    const pct = m.impact === 'high' ? '100%' : m.impact === 'medium' ? '66%' : '33%';
    const col = m.impact === 'high' ? '#888' : '#333';
    movesHTML += `
      <div class="move" style="margin-bottom:22px">
        <span class="move-num">${String(i+1).padStart(2,'0')}</span>
        <div class="move-body">
          <h4>${esc(m.action)}</h4>
          <p>${esc(m.detail)}</p>
          <div class="impact-bar">
            <div class="impact-track"><div class="impact-fill" style="width:${pct};background:${col}"></div></div>
            <span class="impact-label">${esc(m.impact)} impact</span>
          </div>
        </div>
      </div>`;
  });

  const rating = parseFloat(d.rating) || 0;
  const ceiling = parseFloat(d.ceiling) || 0;
  const ringSize = 180;
  const sw = 5;
  const r = (ringSize - sw * 2) / 2;
  const c = 2 * Math.PI * r;

  report.innerHTML = `
    <!-- Hero -->
    <div class="hero">
      ${previewURL ? `<div class="hero-avatar"><img src="${previewURL}" alt=""></div>` : ''}
      <div class="hero-archetype">${esc(d.archetype || '')}</div>
      <p class="hero-opening">${esc(d.opening)}</p>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:6px">
        <span class="hero-fi-label">First impression</span>
        <span class="hero-fi">${esc(d.first_impression || '')}</span>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Rating -->
    <div>
      <div class="sec-head">
        <span class="sec-num">01</span>
        <span class="sec-label">Overall Rating</span>
        <div class="sec-line"></div>
      </div>
      <div class="rating-wrap">
        <div class="ring-container" style="width:${ringSize}px;height:${ringSize}px">
          <svg width="${ringSize}" height="${ringSize}" style="transform:rotate(-90deg)">
            <circle cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#141414" stroke-width="${sw}"/>
            <circle cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#222" stroke-width="${sw}"
              stroke-dasharray="${c}" stroke-dashoffset="${c-(ceiling/10)*c}" stroke-linecap="round" opacity="0.5"/>
            <circle id="rating-arc" cx="${ringSize/2}" cy="${ringSize/2}" r="${r}" fill="none" stroke="#bbb" stroke-width="${sw}"
              stroke-dasharray="${c}" stroke-dashoffset="${c}" stroke-linecap="round"/>
          </svg>
          <div class="ring-value">
            <span class="ring-num" id="ring-num">0.0</span>
            <span class="ring-label">of 10</span>
          </div>
        </div>
        <div class="rating-detail">
          <div class="rating-row">
            <span class="rating-key">Current</span>
            <span class="rating-val" style="color:#bbb">${rating.toFixed(1)}</span>
          </div>
          <div class="rating-row">
            <span class="rating-key">Ceiling</span>
            <span class="rating-val" style="color:#404040">${ceiling.toFixed(1)}</span>
          </div>
          <div style="height:1px;background:#151515;margin:6px 0"></div>
          <p class="rating-context" style="color:#505050">${esc(d.rating_context || '')}</p>
          <p class="rating-context" style="color:#505050">${esc(d.ceiling_context || '')}</p>
          <p class="scale-note">Rated on structural harmony, symmetry, and facial architecture. 5 is average â€” most people fall between 4 and 6. A 7+ is notably above average. 8+ is rare.</p>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Personality -->
    <div>
      <div class="sec-head">
        <span class="sec-num">02</span>
        <span class="sec-label">Personality &amp; Intent</span>
        <div class="sec-line"></div>
      </div>
      <p class="body-text">${esc(d.personality || '')}</p>
    </div>

    <div class="hr"></div>

    <!-- Shadow -->
    <div>
      <div class="sec-head">
        <span class="sec-num">03</span>
        <span class="sec-label">The Shadow</span>
        <div class="sec-line"></div>
      </div>
      <p class="body-text">${esc(d.shadow || '')}</p>
    </div>

    <div class="hr"></div>

    <!-- Best Features -->
    <div>
      <div class="sec-head">
        <span class="sec-num">04</span>
        <span class="sec-label">Strongest Architecture</span>
        <div class="sec-line"></div>
      </div>
      ${featuresHTML}
    </div>

    <div class="hr"></div>

    <!-- Leaks -->
    <div>
      <div class="sec-head">
        <span class="sec-num">05</span>
        <span class="sec-label">Structural Leaks</span>
        <div class="sec-line"></div>
      </div>
      ${leaksHTML}
    </div>

    <div class="hr"></div>

    <!-- Moves -->
    <div>
      <div class="sec-head">
        <span class="sec-num">06</span>
        <span class="sec-label">Highest-ROI Moves</span>
        <div class="sec-line"></div>
      </div>
      ${movesHTML}
    </div>

    <div class="hr" style="margin-top:16px"></div>
    <div class="footer">
      <div class="footer-dot"></div>
      <span>Read</span>
    </div>
  `;

  report.classList.remove('hidden');

  const btn = document.createElement('button');
  btn.className = 'new-read-btn';
  btn.textContent = 'New Read';
  btn.onclick = resetAll;
  report.after(btn);

  animateRing(rating, c);
}

function animateRing(target, circumference) {
  const arc = document.getElementById('rating-arc');
  const num = document.getElementById('ring-num');
  if (!arc || !num) return;
  const t0 = Date.now();
  function tick() {
    const p = Math.min((Date.now() - t0) / 1400, 1);
    const eased = 1 - Math.pow(1 - p, 3);
    const v = eased * target;
    arc.setAttribute('stroke-dashoffset', circumference - (v / 10) * circumference);
    num.textContent = v.toFixed(1);
    if (p < 1) requestAnimationFrame(tick);
  }
  setTimeout(() => requestAnimationFrame(tick), 300);
}

function showError(msg) {
  document.getElementById('error-msg').textContent = msg;
  document.getElementById('error-box').classList.remove('hidden');
}
function hideError() {
  document.getElementById('error-box').classList.add('hidden');
}

function resetAll() {
  compressedBase64 = null;
  if (previewURL) { URL.revokeObjectURL(previewURL); previewURL = null; }
  stopScanAnimation();

  document.getElementById('drop-hint').classList.remove('hidden');
  document.getElementById('preview-wrap').classList.add('hidden');
  document.getElementById('drop-zone').classList.remove('has-img');
  document.getElementById('drop-zone').onclick = function() { document.getElementById('file-input').click(); };
  document.getElementById('analyze-btn').classList.add('hidden');
  document.getElementById('file-input').value = '';

  document.getElementById('scan-screen').classList.add('hidden');
  document.getElementById('report').classList.add('hidden');
  document.getElementById('report').innerHTML = '';
  hideError();
  document.getElementById('upload-screen').classList.remove('hidden');

  const nb = document.querySelector('.new-read-btn');
  if (nb) nb.remove();
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
